name: Extension Release

on:
  push:
    branches:
      - main

jobs:
  release:
    name: Package and Release
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Check Version Change
        id: check
        run: |
          NEW_VERSION=$(bun -e "console.log(JSON.parse(require('fs').readFileSync('manifest.json', 'utf8')).version)")
          
          # Try to get the previous version. If it's the first commit, fallback to an empty version.
          if git rev-parse HEAD^1 >/dev/null 2>&1; then
            OLD_VERSION=$(git show HEAD^1:manifest.json | bun -e "console.log(JSON.parse(require('fs').readFileSync(0, 'utf8')).version)")
          else
            OLD_VERSION="0.0"
          fi
          
          echo "Old version: $OLD_VERSION"
          echo "New version: $NEW_VERSION"
          
          if [ "$NEW_VERSION" != "$OLD_VERSION" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Dependencies
        if: steps.check.outputs.changed == 'true'
        run: bun install

      - name: Build Extension
        if: steps.check.outputs.changed == 'true'
        run: bun run build

      - name: Upload Artifact
        if: steps.check.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: quick-todo-list-v${{ steps.check.outputs.version }}
          path: dist/

      - name: Create Release
        if: steps.check.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.check.outputs.version }}"
          DESCRIPTION=$(bun -e "console.log(JSON.parse(require('fs').readFileSync('manifest.json', 'utf8')).description)")
          
          # Zip the dist folder
          zip -r "extension-v$VERSION.zip" dist/
          
          # Create Release using gh cli
          # This automatically checks if the tag exists; if not, it creates it.
          gh release create "v$VERSION" "extension-v$VERSION.zip" --title "v$VERSION" --notes "$DESCRIPTION"
