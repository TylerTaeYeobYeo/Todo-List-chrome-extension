name: Extension Release

on:
  push:
    branches:
      - main

jobs:
  release:
    name: Package and Release
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for changelog

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Check Version Change
        id: check
        run: |
          NEW_VERSION=$(bun -e "console.log(JSON.parse(require('fs').readFileSync('manifest.template.json', 'utf8')).version)")
          
          # Try to get the previous version. If it's the first commit, fallback to an empty version.
          if git rev-parse HEAD^1 >/dev/null 2>&1; then
            OLD_VERSION=$(git show HEAD^1:manifest.template.json | bun -e "console.log(JSON.parse(require('fs').readFileSync(0, 'utf8')).version)")
          else
            OLD_VERSION="0.0"
          fi
          
          echo "Old version: $OLD_VERSION"
          echo "New version: $NEW_VERSION"
          
          if [ "$NEW_VERSION" != "$OLD_VERSION" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Dependencies
        if: steps.check.outputs.changed == 'true'
        run: bun install

      - name: Build Extension
        if: steps.check.outputs.changed == 'true'
        env:
          FIREBASE_apiKey: ${{ secrets.FIREBASE_APIKEY }}
          FIREBASE_authDomain: ${{ secrets.FIREBASE_AUTHDOMAIN }}
          FIREBASE_projectId: ${{ secrets.FIREBASE_PROJECTID }}
          FIREBASE_storageBucket: ${{ secrets.FIREBASE_STORAGEBUCKET }}
          FIREBASE_messagingSenderId: ${{ secrets.FIREBASE_MESSAGINGSENDERID }}
          FIREBASE_appId: ${{ secrets.FIREBASE_APPID }}
          FIREBASE_measurementId: ${{ secrets.FIREBASE_MEASUREMENTID }}
          GOOGLE_OAUTH: ${{ secrets.GOOGLE_OAUTH }}
        run: bun run build

      - name: Upload Artifact
        if: steps.check.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: quick-todo-list-v${{ steps.check.outputs.version }}
          path: dist/

      - name: Create Release
        if: steps.check.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.check.outputs.version }}"
          DESCRIPTION=$(bun -e "console.log(JSON.parse(require('fs').readFileSync('manifest.template.json', 'utf8')).description)")
          
          # Get previous tag to generate changelog
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s")
          else
            CHANGELOG=$(git log --pretty=format:"- %s" $PREV_TAG..HEAD)
          fi
          
          # Zip the dist folder
          zip -r "extension-v$VERSION.zip" dist/
          
          # Generate Release Notes File
          echo "$DESCRIPTION" > release_notes.md
          echo "" >> release_notes.md
          echo "## Changelog" >> release_notes.md
          echo "$CHANGELOG" >> release_notes.md
          echo "" >> release_notes.md
          echo "Download: https://github.com/${{ github.repository }}/releases/download/v$VERSION/extension-v$VERSION.zip" >> release_notes.md

          # Create Release using gh cli with notes file
          gh release create "v$VERSION" "extension-v$VERSION.zip" --title "v$VERSION" --notes-file release_notes.md
